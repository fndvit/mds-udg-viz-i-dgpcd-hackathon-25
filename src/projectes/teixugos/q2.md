

```js
const schemeCategory10 = [
"#47a5da",
"#7daa42",
"#e67d62",
"#8e9bad",
"#156e9a",
"#4d7117",
"#b23f20",
"#576476",
"#a1d3f2",
"#b0da83",
];

const dades = [
  { qualificacio: "A", Valor_Aillaments: 0.63, Valor_Finestres: 290117.23, Metres_Cadastre: 570.73 },
  { qualificacio: "B", Valor_Aillaments: 0.90, Valor_Finestres: 455170.79, Metres_Cadastre: 554.35 },
  { qualificacio: "C", Valor_Aillaments: 1.28, Valor_Finestres: 579653.48, Metres_Cadastre: 373.21 },
  { qualificacio: "D", Valor_Aillaments: 1.24, Valor_Finestres: 400953.37, Metres_Cadastre: 183.16 },
  { qualificacio: "E", Valor_Aillaments: 1.45, Valor_Finestres: 128390.42, Metres_Cadastre: 111.22 },
  { qualificacio: "F", Valor_Aillaments: 1.61, Valor_Finestres: 136228.25, Metres_Cadastre: 107.76 },
  { qualificacio: "G", Valor_Aillaments: 1.67, Valor_Finestres: 101013.33, Metres_Cadastre: 91.09 }
];
 // Falta modificar input perque funcioni a Observable framework
const variable = Inputs.select(["Valor_Aillaments", "Valor_Finestres", "Metres_Cadastre"], {label: "Variable a mostrar"});


function Treemap(
  data,
  {
    path,
    id = Array.isArray(data) ? (d) => d.id : null,
    parentId = Array.isArray(data) ? (d) => d.parentId : null,
    children,
    value,
    sort = (a, b) => d3.descending(a.value, b.value),
    label,
    group,
    title,
    link,
    linkTarget = "_blank",
    tile = d3.treemapBinary,
    width = 340,
    height = 200,
    margin = 0,
    marginTop = margin,
    marginRight = margin,
    marginBottom = margin,
    marginLeft = margin,
    padding = 1,
    paddingInner = padding,
    paddingOuter = padding,
    paddingTop = paddingOuter,
    paddingRight = paddingOuter,
    paddingBottom = paddingOuter,
    paddingLeft = paddingOuter,
    round = true,
    colors = schemeCategory10,
    zDomain,
    fill = "#ccc",
    fillOpacity = group == null ? null : 1,
    stroke,
    strokeWidth,
    strokeOpacity,
    strokeLinejoin,
    labelFillDark = "#000",
    labelFillLight = "#fff",
    labelFontWeight = "bold"
  } = {}
) {
  const root =
    path != null
      ? d3.stratify().path(path)(data)
      : id != null || parentId != null
      ? d3.stratify().id(id).parentId(parentId)(data)
      : d3.hierarchy(data, children);

  value == null ? root.count() : root.sum((d) => Math.max(0, value(d)));

  const leaves = root.leaves();
  const G = group == null ? null : leaves.map((d) => group(d.data, d));
  if (zDomain === undefined) zDomain = G;
  zDomain = new d3.InternSet(zDomain);
  const color = group == null ? null : d3.scaleOrdinal(zDomain, colors);

  const L = label == null ? null : leaves.map((d) => label(d.data, d));
  const T =
    title === undefined
      ? L
      : title == null
      ? null
      : leaves.map((d) => title(d.data, d));

  if (sort != null) root.sort(sort);

  const contrastTextColor = (color) =>
    d3.lab(color).l < 65 ? labelFillLight : labelFillDark;

  d3
    .treemap()
    .tile(tile)
    .size([width - marginLeft - marginRight, height - marginTop - marginBottom])
    .paddingInner(paddingInner)
    .paddingTop(paddingTop)
    .paddingRight(paddingRight)
    .paddingBottom(paddingBottom)
    .paddingLeft(paddingLeft)
    .round(round)(root);

  const svg = d3
    .create("svg")
    .attr("viewBox", [-marginLeft, -marginTop, width, height])
    .attr("width", width)
    .attr("height", height)
    .attr("style", "max-width: 100%; height: auto; height: intrinsic;")
    .style("background", "white")
    .attr("font-family", "sans-serif")
    .attr("font-size", 10);

  const node = svg
    .selectAll("a")
    .data(leaves)
    .join("a")
    .attr("xlink:href", link == null ? null : (d, i) => link(d.data, d))
    .attr("target", link == null ? null : linkTarget)
    .attr("transform", (d) => `translate(${d.x0},${d.y0})`);

  node
    .append("rect")
    .attr("fill", color ? (d, i) => color(G[i]) : fill)
    .attr("fill-opacity", fillOpacity)
    .attr("stroke", stroke)
    .attr("stroke-width", strokeWidth)
    .attr("stroke-opacity", strokeOpacity)
    .attr("stroke-linejoin", strokeLinejoin)
    .attr("width", (d) => d.x1 - d.x0)
    .attr("height", (d) => d.y1 - d.y0);

  if (T) {
    node.append("title").text((d, i) => T[i]);
  }

  if (L) {
    const uid = `O-${Math.random().toString(16).slice(2)}`;

    node
      .append("clipPath")
      .attr("id", (d, i) => `${uid}-clip-${i}`)
      .append("rect")
      .attr("width", (d) => d.x1 - d.x0)
      .attr("height", (d) => d.y1 - d.y0);

    node
      .append("text")
      .attr(
        "clip-path",
        (d, i) => `url(${new URL(`#${uid}-clip-${i}`, location)})`
      )
      .attr(
        "fill",
        color
          ? (d, i) => contrastTextColor(color(G[i]))
          : contrastTextColor(fill)
      )
      .selectAll("tspan")
      .data((d, i) => `${L[i]}`.split(/\n/g))
      .join("tspan")
      .attr("x", 3)
      .attr("y", (d, i, D) => `${(i === D.length - 1) * 0.3 + 1.1 + i * 0.9}em`)
      .attr("fill-opacity", (d, i, D) => (i === D.length - 1 ? 0.7 : null))
      .style("font-weight", labelFontWeight)
      .text((d) => d);
  }

  return Object.assign(svg.node(), { scales: { color } });
}

const treemap_chart = Treemap(dades, {
  path: (d) => d?.qualificacio,
  value: (d) => d?.[variable],
  group: (d) => d?.qualificacio,
  label: (d, n) =>
    [
      d.qualificacio,
      `${n.value.toLocaleString("en")}`
    ].join("\n"),
  title: (d, n) => `${d.qualificacio}\n${n.value.toLocaleString("en")}`,
  tile: d3.treemapBinary,
  width: 700,
  height: 500
});

```
Link al notebook: https://observablehq.com/d/5e968bf742ee83c9
  <table style="width: 100%; border: 1px solid black;">
  <thead>
    <tr>
      <th style="border: 1px solid black; padding: 8px; text-align: left;">Qualificaci√≥</th>
      <th style="border: 1px solid black; padding: 8px; text-align: left;">Valor Aillaments</th>
      <th style="border: 1px solid black; padding: 8px; text-align: left;">Valor Finestres</th>
      <th style="border: 1px solid black; padding: 8px; text-align: left;">Metres Cadastre</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td style="border: 1px solid black; padding: 8px;">A</td>
      <td style="border: 1px solid black; padding: 8px;">0.63</td>
      <td style="border: 1px solid black; padding: 8px;">290117.23</td>
      <td style="border: 1px solid black; padding: 8px;">570.73</td>
    </tr>
    <tr>
      <td style="border: 1px solid black; padding: 8px;">B</td>
      <td style="border: 1px solid black; padding: 8px;">0.9</td>
      <td style="border: 1px solid black; padding: 8px;">455170.79</td>
      <td style="border: 1px solid black; padding: 8px;">554.35</td>
    </tr>
    <tr>
      <td style="border: 1px solid black; padding: 8px;">C</td>
      <td style="border: 1px solid black; padding: 8px;">1.28</td>
      <td style="border: 1px solid black; padding: 8px;">579653.48</td>
      <td style="border: 1px solid black; padding: 8px;">373.21</td>
    </tr>
    <tr>
      <td style="border: 1px solid black; padding: 8px;">D</td>
      <td style="border: 1px solid black; padding: 8px;">1.24</td>
      <td style="border: 1px solid black; padding: 8px;">400953.37</td>
      <td style="border: 1px solid black; padding: 8px;">183.16</td>
    </tr>
    <tr>
      <td style="border: 1px solid black; padding: 8px;">E</td>
      <td style="border: 1px solid black; padding: 8px;">1.45</td>
      <td style="border: 1px solid black; padding: 8px;">128390.42</td>
      <td style="border: 1px solid black; padding: 8px;">111.22</td>
    </tr>
    <tr>
      <td style="border: 1px solid black; padding: 8px;">F</td>
      <td style="border: 1px solid black; padding: 8px;">1.61</td>
      <td style="border: 1px solid black; padding: 8px;">136228.25</td>
      <td style="border: 1px solid black; padding: 8px;">107.76</td>
    </tr>
    <tr>
      <td style="border: 1px solid black; padding: 8px;">G</td>
      <td style="border: 1px solid black; padding: 8px;">1.67</td>
      <td style="border: 1px solid black; padding: 8px;">101013.33</td>
      <td style="border: 1px solid black; padding: 8px;">91.09</td>
    </tr>
  </tbody>
</table>

